const pg = require('utils/pg')

module.exports = async function ({ sale_id  }, pgClient = null) {
  const db = pgClient === null ? pg : pgClient

  await db.query(/*sql*/`
    WITH inserted_invoices (invoice_id, economic_activity_id) AS (
      -- insert invoices
      INSERT INTO accounting.invoice (economic_activity_id, amount)
      SELECT
        webstore.product.economic_activity_id
        SUM(webstore.sale_listing.quantity
          * webstore.listing_product.quantity
          * webstore.listing_product.price) AS amount
      FROM webstore.sale_listing
      LEFT JOIN webstore.listing_product ON webstore.sale_listing.listing_id = webstore.listing_product.listing_id
      LEFT JOIN webstore.product ON webstore.listing_product.product_id = webstore.product.product_id
      WHERE webstore.sale_listing.sale_id = $1
      GROUP BY webstore.product.economic_activity_id
    ), inserted_invoice_items (invoice_id, index) AS (
      -- insert invoice lines
      INSERT INTO accounting.invoice_item (invoice_id, index, name, quantity, price)
      SELECT
        inserted_invoices.invoice_id,
        ROW_NUMBER () OVER (PARTITION BY webstore.product.economic_activity_id) AS index,
        webstore.product_i18n.name AS name, -- get names from i18n
        webstore.listing_product.quantity * webstore.sale_listing.quantity AS quantity,
        webstore.listing_product.price AS price
      FROM webstore.sale
      LEFT JOIN account.user USING (user_id)
      LEFT JOIN webstore.sale_listing USING (sale_id)
      LEFT JOIN webstore.listing_product USING (listing_id)
      LEFT JOIN webstore.product USING (product_id)
      LEFT JOIN webstore.product_i18n
        ON webstore.product_i18n.product_id = webstore.product.product_id
        AND webstore.product_i18n.locale_id = account.user.locale_id
      WHERE webstore.sale.sale_id = $1
    ), inserted_sale_invoices (sale_id, invoice_id) AS (
      -- insert link to sale
      INSERT INTO webstore.sale_invoice (sale_id, invoice_id)
      SELECT inserterted_invoices.invoice_id, $1 FROM inserted_invoices
    ) SELECT invoice_id FROM inserted_invoices
  `, [ sale_id ])
}
