const pg = require('utils/pg')

module.exports = async function createWebstoreSale ({ user_id, client_id }, pgClient = null) {
  const db = pgClient === null ? pg : pgClient

  const { rows: [ { sale_id } ] } = await db.query(`
    WITH inserted_sale (sale_id) AS (
      INSERT INTO webstore.sale (user_id, client_id)
      VALUES ($1, $2)
      RETURNING sale_id
    ), inserted_sale_listings (listing_id, quantity) AS (
      INSERT INTO webstore.sale_listing (sale_id, listing_id, quantity)
      SELECT
        inserted_sale.sale_id,
        webstore.cart_listing.listing_id,
        webstore.cart_listing.quantity
      FROM inserted_sale CROSS JOIN webstore.cart_listing
      WHERE webstore.cart_listing.user_id = $1
      RETURNING listing_id, quantity
    ) SELECT inserted_sale.sale_id
    FROM inserted_sale
  `, [ user_id, client_id ])

  return sale_id
}
