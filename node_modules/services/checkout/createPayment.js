const pg = require('utils/pg')

module.exports = async function createPayment ({ payment_id, sale_id, amount, khipuPayment }, pgClient = null) {
  const db = pgClient === null ? pg : pgClient

  const {
    khipu_payment_id,
    khipu_payment_url,
    khipu_app_url,
    khipu_ready_for_terminal
  } = khipuPayment
  await db.query(`
    WITH payment (payment_id) AS (
      INSERT INTO accounting.payment(
        payment_id,
        amount,
        khipu_payment_id,
        khipu_payment_url,
        khipu_app_url,
        khipu_ready_for_terminal
      ) VALUES ($2, $3, $4, $5, $6, $7)
      RETURNING payment_id
    ) INSERT INTO webstore.sale_payment (sale_id, payment_id)
    VALUES ($1, $2)
  `, [
    sale_id,
    payment_id,
    amount,
    // khipu params
    khipu_payment_id,
    khipu_payment_url,
    khipu_app_url,
    khipu_ready_for_terminal
  ])
}
