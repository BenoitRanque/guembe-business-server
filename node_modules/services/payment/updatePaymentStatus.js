const pg = require('utils/pg')

module.exports = async function ({ payment_id, update, payment, paymentUpdates }, pgClient = null) {
  const db = pgClient === null ? pg : pgClient

  let status = null

  if (update.status_detail) {
    switch (update.status_detail) {
      case 'pending':
        status = 'PENDING'
        break
      case 'normal':
        status = 'COMPLETED'
        break
      case 'marked-paid-by-receiver':
        status = 'COMPLETED'
        break
      case 'rejected-by-payer':
        status = 'REJECTED'
        break
      case 'marked-as-abuse':
        status = 'REJECTED'
        break
      case 'reversed':
        status = 'REVERSED'
        break
      default:
        throw new Error(`Unknown khipu_status_detail ${update.status_detail}`)
    }
  }

  if (status && status !== payment.status) {
    if (payment.status === 'PENDING') {
      if (status === 'COMPLETED' || status === 'REJECTED') {
        await db.query(/*sql*/`
          INSERT INTO accounting.payment_update (payment_id, status)
          VALUES ($1, $2)
        `, [ payment_id, status ])

        return { status }
      }
    }
  }

  return { status: null }
}

