const pg = require('utils/pg')

module.exports = async function ({ sale_id }, pgClient = null) {
  const db = pgClient === null ? pg : pgClient
  await db.query(/*sql*/`
    WITH vouchers (voucher_id, sale_id, listing_id, aquired, product_id, quantity) AS (
      SELECT
        gen_random_uuid() AS voucher_id,
        webstore.sale_listing.sale_id,
        webstore.sale_listing.listing_id,
        SUM(webstore.sale_listing.quantity * webstore.listing_product.quantity) AS aquired,
        webstore.listing_product.product_id AS product_id,
        1 AS quantity
      FROM webstore.sale_listing
      LEFT JOIN webstore.listing USING (listing_id)
      LEFT JOIN webstore.listing_product USING (listing_id)
      WHERE webstore.listing.emit_multiple_vouchers = true
      AND webstore.sale_listing.sale_id = $1
      GROUP BY webstore.sale_listing.sale_id, webstore.sale_listing.listing_id, webstore.listing_product.product_id
      UNION ALL
      SELECT
        gen_random_uuid() AS voucher_id,
        webstore.sale_listing.sale_id,
        webstore.sale_listing.listing_id,
        webstore.sale_listing.quantity AS aquired,
        null AS product_id,
        null AS quantity
      FROM webstore.sale_listing
      LEFT JOIN webstore.listing USING (listing_id)
      WHERE webstore.listing.emit_multiple_vouchers = false
      AND webstore.sale_listing.sale_id = $1
    ), inserted_vouchers AS (
      INSERT INTO webstore.voucher (voucher_id, sale_id, listing_id, aquired)
      SELECT
        vouchers.voucher_id,
        vouchers.sale_id,
        vouchers.listing_id,
        vouchers.aquired
      FROM vouchers
    ), inserted_voucher_products AS (
      INSERT INTO webstore.voucher_product (voucher_id, product_id, quantity)
      SELECT
        vouchers.voucher_id,
        vouchers.product_id,
        vouchers.quantity
      FROM vouchers
      WHERE product_id IS NOT NULL
      UNION ALL
      SELECT
        vouchers.voucher_id,
        webstore.listing_product.product_id,
        webstore.listing_product.quantity
      FROM vouchers LEFT JOIN webstore.listing_product USING (listing_id)
      WHERE vouchers.product_id IS NULL
    ) SELECT voucher_id FROM vouchers
  `, [ sale_id ])
}
