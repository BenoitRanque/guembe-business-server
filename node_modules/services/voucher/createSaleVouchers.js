const pg = require('utils/pg')

module.exports = async function ({ sale_id }, pgClient = null) {
  const db = pgClient === null ? pg : pgClient

  await db.query(/*sql*/`
    WITH independend_vouchers (sale_id, listing_id, aquired, product_id, quantity) AS (
      SELECT
        webstore.sale_listing.sale_id,
        webstore.sale_listing.listing_id,
        webstore.sale_listing.quantity * webstore.listing_product.quantity AS aquired,
        webstore.listing_product.product_id AS product_id,
        1 AS quantity
      FROM webstore.sale_listing
      LEFT JOIN webstore.listing USING (listing_id)
      LEFT JOIN webstore.listing_product USING (listing_id)
      WHERE webstore.listing.products_usable_separately = true
      AND webstore.sale_listing.sale_id = $1
    ), inserted_independent_vouchers (voucher_id) AS (
      INSERT INTO webstore.voucher (sale_id, listing_id, aquired)
      RETURNING voucher_id
      SELECT sale_id, listing, aquired
      FROM independend_vouchers
    ), inserted_independent_voucher_products (voucher_product_id) AS (
      INSERT INTO webstore.voucher_product (voucher_id, product_id, quantity)
      RETURNING voucher_product_id
      SELECT
        independend_vouchers.voucher_id,
        independend_vouchers.product_id,
        independend_vouchers.quantity
      FROM independend_vouchers CROSS JOIN inserted_independent_vouchers
    ), inserted_vouchers (voucher_id, sale_id, listing_id, aquired) AS (
      INSERT INTO webstore.voucher (sale_id, listing_id, aquired)
      RETURNING voucher_id, sale_id, listing_id, aquired
      SELECT
        webstore.sale_listing.sale_id
        webstore.sale_listing.listing_id,
        webstore.sale_listing.quantity AS aquired
      FROM webstore.sale_listing
      LEFT JOIN webstore.listing USING (listing_id)
      WHERE webstore.listing.products_usable_separately = false
      AND webstore.sale_listing.sale_id = $1
    ), inserted_voucher_products (voucher_product_id) AS (
      INSERT INTO webstore.voucher_product (voucher_id, product_id, quantity)
      RETURNING voucher_product_id
      SELECT
        inserted_vouchers.voucher_id,
        inserted_vouchers.product_id,
        listing_product.quantity
      FROM inserted_vouchers
      LEFT JOIN webstore.listing_product USING (listing_id)
    ) SELECT voucher_id
    FROM inserted_independent_vouchers
    UNION ALL
    SELECT voucher_id
    FROM inserted_vouchers
  `, [ sale_id ])
}
