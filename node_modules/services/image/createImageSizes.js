const sharp = require('sharp')
const uuid = require('uuid/v4')

module.exports = async function createImageSizes(imageBuffer, sizes) {
  const image_id = uuid()

  try {
    await Promise.all(sizes.map(({ size_id, width, height}) => {
      sharp(imageBuffer)
        .resize(width, height)
        .jpeg({ quality: 100, progressive: true })
        .toFile(`${process.env.FILE_UPLOAD_DIRECTORY}/image/${image_id}.${size_id}.jpg`)
    }))

    return image_id
  } catch (error) {
    removeImageSizes(image_id, sizes)
    throw error
  }
}